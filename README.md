SELECT  
    IAM_FIRM_EMPANELMENT.FRN,  
    IAM_FIRM_EMPANELMENT.FIRM_NAME, 
    IAM_FIRM_EMPANELMENT.EMPANELMENT_TYPE, 
    IAM_FIRM_EMPANELMENT.EMPANELMENT_SUB_TYPE,  
    IAM_FIRM_EMPANELMENT.POC_EMAIL,  
    IAM_FIRM_EMPANELMENT.CONTACT_PERSON,  
    IAM_FIRM_EMPANELMENT.REF_NO,  

    IAM_FIRM_MASTER_DETAILS.GSTN_NO,  
    IAM_FIRM_MASTER_DETAILS.ADDRESS,  
    IAM_FIRM_MASTER_DETAILS.CITY,

    (SELECT EMAIL_STATUS 
     FROM IAM_EMAIL_LOGS 
     WHERE IAM_EMAIL_LOGS.FRN_NO = IAM_FIRM_EMPANELMENT.FRN 
        OR IAM_EMAIL_LOGS.FRN_NO = IAM_FIRM_MASTER_DETAILS.FRN_NO
        AND RMLID = (
            SELECT MAX(R2.RMLID)
            FROM IAM_EMAIL_LOGS R2
            WHERE R2.FRN_NO = IAM_EMAIL_LOGS.FRN_NO
        )
     FETCH FIRST 1 ROWS ONLY
    ) AS EMAIL_STATUS

FROM IAM_FIRM_EMPANELMENT

LEFT JOIN IAM_FIRM_MASTER_DETAILS
    ON IAM_FIRM_EMPANELMENT.FRN = IAM_FIRM_MASTER_DETAILS.FRN_NO

WHERE IAM_FIRM_EMPANELMENT.FINANCIAL_YEAR = :finyear  
    AND IAM_FIRM_EMPANELMENT.EMPANELED_STATUS = 'YES' 
    AND IAM_FIRM_EMPANELMENT.EMPANELMENT_TYPE = :emptype 
    AND IAM_FIRM_EMPANELMENT.EMPANELMENT_SUB_TYPE = :empSubtype
