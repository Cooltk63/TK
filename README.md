SELECT  
    IAM_FIRM_EMPANELMENT.FRN,  
    IAM_FIRM_EMPANELMENT.FIRM_NAME, 
    IAM_FIRM_EMPANELMENT.EMPANELMENT_TYPE, 
    IAM_FIRM_EMPANELMENT.EMPANELMENT_SUB_TYPE,  
    IAM_FIRM_EMPANELMENT.POC_EMAIL,  
    IAM_FIRM_EMPANELMENT.CONTACT_PERSON,  
    IAM_FIRM_EMPANELMENT.REF_NO,  
    IAM_FIRM_MASTER_DETAILS.GSTN_NO,  
    IAM_FIRM_MASTER_DETAILS.ADDRESS,  
    IAM_FIRM_MASTER_DETAILS.CITY,
    IEL.EMAIL_STATUS
FROM  
    IAM_FIRM_EMPANELMENT   
LEFT JOIN  
    IAM_FIRM_MASTER_DETAILS    
    ON IAM_FIRM_EMPANELMENT.FRN = IAM_FIRM_MASTER_DETAILS.FRN_NO 
LEFT JOIN (
    SELECT
        FRN,
        EMAIL_STATUS,
        RMLID
    FROM IAM_EMAIL_LOGS l
    INNER JOIN (
        -- Subquery to get max RMLID per FRN
        SELECT FRN, MAX(RMLID) AS max_rmlid
        FROM IAM_EMAIL_LOGS
        GROUP BY FRN
    ) ml ON l.FRN = ml.FRN AND l.RMLID = ml.max_rmlid
) IEL
    ON IEL.FRN = IAM_FIRM_EMPANELMENT.FRN
    OR IEL.FRN = IAM_FIRM_MASTER_DETAILS.FRN_NO
WHERE 
    FINANCIAL_YEAR = :finyear  
    AND EMPANELED_STATUS = 'YES' 
    AND EMPANELMENT_TYPE = :emptype 
    AND EMPANELMENT_SUB_TYPE = :empSubtype
